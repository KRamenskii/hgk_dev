name: HGK Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üîç Debug secrets (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
        run: |
          echo "USER=${{ secrets.SERVER_USER }}"
          echo "HOST=${{ secrets.SERVER_HOST }}"
          echo "PATH=${{ secrets.SERVER_PATH }}"

      - name: üîë Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üìú Add server to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üõ†Ô∏è Deploy to server
        run: |
          echo "–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            
            echo "üì¶ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
            cd ${{ secrets.SERVER_PATH }}
            
            echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "üêç –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            source venv/bin/activate
            
            echo "üìö –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            pip install -r requirements.txt
            
            echo "üß∞ –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
            python manage.py migrate --settings=project.settings.prod
            
            echo "üß± –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏–∫—É..."
            python manage.py collectstatic --noinput --settings=project.settings.prod
            
            echo "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Gunicorn –∏ Nginx..."
            sudo systemctl restart gunicorn
            sudo systemctl restart nginx
            
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          EOF