{% extends "base_plain.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div>
    <form action="{% url 'logout' %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-secondary btn-sm">–í—ã–π—Ç–∏</button>
    </form>
    </div>
  </div>

  <form method="get" class="row g-2 align-items-end mb-4">
    <div class="col-auto">
      <label for="id_date" class="form-label">–î–∞—Ç–∞</label>
      <input id="id_date" type="date" name="date" class="form-control" value="{{ filter_date }}">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-primary">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="col-auto">
      <a href="{% url 'analytics_stats' %}" class="btn btn-secondary">–°–±—Ä–æ—Å</a>
    </div>
    <div class="col-auto ms-auto">
      <span class="badge text-bg-info">–ü–æ—Å–µ—â–µ–Ω–∏—è: {{ visits_count }}</span>
      <span class="badge text-bg-warning">–ö–ª–∏–∫–∏: {{ clicks_count }}</span>
    </div>
  </form>

  <div class="card mb-4">
    <div class="card-header">üìà –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 7 –¥–Ω–µ–π</div>
    <div class="card-body">
      <canvas id="analyticsChart" height="120"></canvas>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è</div>
        <div class="card-body p-0">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr><th>–°—Ç—Ä–∞–Ω–∏—Ü–∞</th><th>IP</th><th>–ë—Ä–∞—É–∑–µ—Ä</th><th>–í—Ä–µ–º—è</th></tr>
            </thead>
            <tbody>
              {% for v in page_visits %}
              <tr>
                <td>{{ v.page_url }}</td>
                <td>{{ v.ip_address }}</td>
                <td title="{{ v.user_agent }}">{{ v.user_agent|truncatechars:40 }}</td>
                <td>{{ v.timestamp|date:"d.m.Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–ª–∏–∫–∏</div>
        <div class="card-body p-0">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr><th>–ö–Ω–æ–ø–∫–∞</th><th>–°—Ç—Ä–∞–Ω–∏—Ü–∞</th><th>IP</th><th>–í—Ä–µ–º—è</th></tr>
            </thead>
            <tbody>
              {% for c in button_clicks %}
              <tr>
                <td>{{ c.button_id }}</td>
                <td>{{ c.page_url }}</td>
                <td>{{ c.ip_address }}</td>
                <td>{{ c.timestamp|date:"d.m.Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center py-3">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ chart_labels|safe }};
const visits = {{ chart_visits|safe }};
const clicks = {{ chart_clicks|safe }};

const ctx = document.getElementById('analyticsChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets: [
      { label: '–ü–æ—Å–µ—â–µ–Ω–∏—è', data: visits, tension: 0.3, fill: true },
      { label: '–ö–ª–∏–∫–∏', data: clicks, tension: 0.3, fill: true }
    ]
  },
  options: {
    responsive: true,
    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
    plugins: { legend: { position: 'top' } }
  }
});
</script>
{% endblock %}